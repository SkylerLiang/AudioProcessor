#include "audio_process.h"
#include "arm_const_structs.h"

int16_t audio_buffer[2][512];
int16_t audio_buffer_mixed[1024];
float32_t Ak[2048] = {0}, Bk[2048] = {0};
float32_t temp[2048] = {0};
float32_t mags[1024] = {0};
float32_t corrBuffer[1024] = {0};
float32_t phi[1024] = {0};
int16_t adad[1024];

void Audio_Get_From_Mic(Mic_Pair_t *pMics, int16_t *bufferL, int16_t *bufferR, int16_t *bufferM)
{
	int16_t value[2];
	uint8_t *pointer;
	uint32_t *bufferPointer = pMics->validDataPointer;
	for(uint16_t i = 0; i < 512; i++)
	{
//		int16_t testA[512] = {-888, 513, 322, 767, -785, 569, -834, 502, 707, 875, -58, 991, 231, -448, 13, 934, -177, -717, -83, -146, 734, 271, -485, -744, -476, -1000, 541, -615, 399, -904, 743, 908, -467, -721, -799, 598, 107, 762, -119, 689, -483, -825, -916, -581, 863, -195, -677, -318, -772, 802, -396, 807, 179, -495, 176, 748, -880, 123, 129, -28, 632, 861, -119, -590, 288, -299, -575, -500, 80, -495, 517, -701, 82, 520, 271, 38, -125, -878, -101, 832, -315, 544, -581, -657, -263, 123, 287, -923, -80, -895, 576, 927, 243, -899, 522, 33, 756, 731, 200, -78, -675, -375, 911, 268, 732, -712, 43, 805, -55, -281, 635, 278, 116, -752, 633, 603, -342, 606, -924, 976, 118, -590, -968, -546, -607, -943, -185, -423, 957, -486, 35, 585, -687, 986, 826, -7, 738, 723, 895, -409, 355, 956, -660, 97, -513, -651, 66, 860, -439, -318, 711, -616, -375, -2, -376, 132, 734, -446, -160, 360, -939, 221, -207, 279, 662, -473, -483, -926, 451, -344, -561, -500, 737, -419, -360, -719, 818, -429, -801, -608, 100, -635, 862, 870, -835, -338, 484, -6, 244, -555, 186, 420, 955, 326, -996, 922, 609, 770, -291, 14, -461, -688, 403, -870, -699, -543, -897, 33, 254, 81, -914, 693, -321, -188, -874, 342, -41, 922, 457, -707, 65, 870, 373, 91, -533, -86, -257, 304, 642, -695, 785, -422, 598, 650, 498, 88, -760, 766, -993, 758, -882, 807, 669, -777, 319, -880, -16, -990, -331, -435, 333, 156, -11, 159, -838, -716, -548, -934, -545, -73, -570, 600, 102, 950, -460, -644, 439, -784, -867, -244, 1, 363, 486, -567, -680, -537, 204, 353, -491, 893, 103, -26, -914, -604, -496, -953, -847, 29, -386, 550, -897, 208, 481, -274, -310, -209, -534, -190, 332, 325, 640, -466, -159, -433, -366, -947, 844, -378, 47, 239, -37, 853, -991, -261, 439, -791, 101, -625, 855, 130, 273, -503, -460, -328, 919, -112, 765, 979, 501, -592, 113, -106, -327, 291, 612, -332, 736, -681, 715, 419, -4, -626, 376, -177, -153, 97, -286, -93, -92, -513, 463, -982, -2, -11, 55, 621, -625, -997, 907, -355, -206, 992, 434, 545, -775, 2, -459, 536, -847, 795, -905, -6, -916, 789, 224, 0, -253, -597, 387, 839, 179, 563, -495, 529, 368, 585, -731, -1000, 996, 239, 821, -626, 662, -255, -435, -618, 869, 750, 107, 697, 555, 893, 242, -208, -709, 624, -389, -326, -237, 941, -578, 920, 188, -313, -500, -648, -259, 207, -833, 790, 644, -365, 947, -963, 291, -458, -727, 475, -390, 681, -918, 423, -433, -209, -532, 771, -99, -118, -490, 270, -86, 35, 971, 327, -569, 331, 439, 464, -680, 121, 281, -132, 86, -734, 857, 200, 157, 348, -532, 241, -891, 70, -151, -546, 128, -753, -744, 283, -632, 459, 284, -212, 259, 471, 186, -32, -980, 682, 824, 904, 237, -951, 866, -504, 591, 1, -93, -564, -725, 448, -647, -948, -328, -463, 117, 86, -990, -539, 943, 169, -597, 361, -189, 300, 762, -219, 403, 177, -281, 70, -69, -397};
//		int16_t testB[512] = {185, 375, 516, 515, 596, -743, -822, -16, 891, 116, -324, 220, 620, 791, 943, 75, -461, -960, -760, 899, -453, 321, 380, -824, 163, -819, -155, -324, 425, -399, -988, -560, -799, -102, 209, -369, -168, -296, 386, 174, 144, -591, -359, -321, -626, 314, 225, -327, -860, 500, -390, 654, 111, -879, 851, -886, -88, -635, 498, 260, -486, 117, 268, 406, -450, 918, -171, 482, 494, 0, 609, 277, 802, -816, -561, -666, -107, -677, 339, 807, -729, -786, -897, 806, 70, 970, 532, 773, -145, 915, -333, 576, 504, 830, -352, 691, 228, -171, -985, -244, 925, -161, 793, -785, 646, -314, 79, -425, 492, -322, -642, 822, 839, 966, 257, 54, 207, -204, -842, -797, -454, 134, -975, -413, -774, 7, 922, -42, 810, 584, -714, -678, -778, 604, -24, 883, -545, -291, 621, -970, -7, 194, 411, 270, -459, -430, 103, -386, -338, 858, 926, -998, -1000, -569, 193, -77, -957, -718, -940, -714, 986, -491, -421, -176, 270, 529, 173, 161, -258, 859, 492, -37, 614, 68, -720, -21, -643, 116, -344, -552, 567, -547, -511, 2, 97, -143, 190, 879, -461, 655, -133, -563, 950, -787, 832, 226, -341, 728, -339, 528, -99, -824, 388, 209, 83, 464, -971, -423, -468, 264, 171, -248, -843, -975, 497, -41, -878, -160, -274, 264, -627, -223, -155, -806, 193, 207, -892, 70, -447, 904, -663, 641, 15, -530, 754, 794, -941, -253, -918, -487, -756, -941, -445, -147, -502, 718, -181, 878, -547, -230, 5, -599, -470, -187, -43, -179, -693, 945, 65, 701, 282, 614, 109, -438, -894, -5, 721, 985, 31, -139, -767, 831, 231, -872, -328, -439, 800, 653, -410, -433, -130, 619, -99, 665, -147, 432, 901, -968, -749, 373, -61, 963, -953, 526, 159, 27, -935, -163, -765, 121, -964, 510, 650, 510, -978, 768, 75, 676, -271, 961, -841, -448, -147, -402, 739, 62, -13, -458, -374, 440, -1000, 278, 732, 358, 820, -328, -943, 778, -317, 236, 412, 224, -433, 47, -296, -112, -248, -317, 553, -933, -40, -861, -418, 697, -483, 250, 705, -617, -484, -46, 669, -816, -523, -333, -933, 288, 368, 640, 241, 744, 666, 752, -67, -660, 448, -338, -421, -708, -235, 825, -487, -894, 725, -353, -57, -400, 582, -336, 861, -241, -958, 91, 323, 326, 858, -731, 419, -644, 349, 699, 590, -270, 96, -863, 32, 871, -792, 186, 944, 694, 428, 735, -766, -580, -337, 995, -32, -71, 283, 400, 335, 448, 556, 923, -154, -914, -717, 184, 832, -919, -821, 938, -947, -974, -906, -942, 499, -1000, 283, -511, -878, 885, -794, 94, -396, -9, 16, 563, -785, -753, -728, -851, -716, -632, 975, -765, 93, 892, -878, 365, -696, -861, -816, 749, 344, -938, 939, 910, -680, -986, -315, -209, 423, -703, -100, -236, -157, 617, 798, -80, 70, 239, 116, -31, -330, -943, -851, 693, 487, -364, 975, 104, -135, -251, -608, -286, -3, -137, -662, -476, -142, -429, 524, 451, -770, 854, 294, -499, 801, 285, 46, -388, -536, -612, -889, -3, -950, 755, 218, -257, 309, -378};
//		memcpy(&bufferL[i], &testA[i], 2);
//		memcpy(&bufferR[i], &testB[i], 2);
	
		pointer = (uint8_t *)&bufferPointer[i * 2];
		
		memcpy(&value[0], pointer + 1, 2);
		memcpy(&value[1], pointer + 5, 2);
		
		// process
		value[0] *= 20;
		value[1] *= 20;
		
		memcpy(&bufferL[i], &value[0], 2);
		memcpy(&bufferR[i], &value[1], 2);
		memcpy(&bufferM[i * 2], value, 4);
		
		/********** test **********/
//		int16_t sin = (int16_t)(20000 * arm_sin_f32(i * 2 * M_PI / 64));
//		int16_t cos = (int16_t)(20000 * arm_cos_f32(i * 2 * M_PI / 64));
//		bufferM[i * 2] = sin;
//		bufferM[i * 2 + 1] = cos;
//		bufferL[i] = sin;
//		bufferR[i] = cos;
	}
}

void Audio_Correlate(int16_t *inA, int16_t *inB, float *out)
{	
	arm_fill_f32(0.0, Ak, 2048);
	arm_fill_f32(0.0, Bk, 2048);
	arm_fill_f32(0.0, temp, 2048);
	
	// pading
	for(uint16_t i = 0; i < 512; i++)
	{
		Ak[i * 2] = (float32_t)inA[i];
		Bk[i * 2] = (float32_t)inB[i];
	}
	
	// FFT Init
	const arm_cfft_instance_f32 *cfft_instance = &arm_cfft_sR_f32_len1024;
	
	// FFT
	arm_cfft_f32(cfft_instance, Ak, 0, 1);
	arm_cfft_f32(cfft_instance, Bk, 0, 1);
	
	// Conj to B
	arm_copy_f32(Bk, temp, 2048);
	arm_cmplx_conj_f32(temp, Bk, 1024);
	
	// mult
	arm_cmplx_mult_cmplx_f32(Ak, Bk, temp, 1024);
	
	// mag
//	arm_cmplx_mag_f32(temp, mags, 1024);
//	
//	for(uint16_t i = 0; i < 1024; i++)
//	{
//		temp[2 * i] /= mags[i];
//		temp[2 * i + 1] /= mags[i];
//	}
	
	// IFFT
	arm_cfft_f32(cfft_instance, temp, 0, 1);
	
	for(uint16_t i = 0; i < 1024; i++)
	{
		out[i] = (float)temp[i * 2];
	}
	
//	arm_correlate_q15(inA, 512, inB, 512, adad);

}

void Buffer_Get_Max(float *buff, uint32_t len, uint32_t *maxIndex, float *maxValue)
{
	arm_max_f32(buff, len, maxValue, maxIndex);
}

// dis(L) - dis(R)
float Audio_Calc_Distance(int16_t *audioL, int16_t *audioR)
{
	uint32_t idx;
	float max;
	
	Audio_Correlate(audioL, audioR, corrBuffer);
	Buffer_Get_Max(corrBuffer, 1024, &idx, &max);
	
	// 1 / 22000 * 340
	if (idx < 512)
	{
		return - 21.25f * (int)idx;
	}
	else
	{
		return 21.25f * (1023 - idx);
	}
}
